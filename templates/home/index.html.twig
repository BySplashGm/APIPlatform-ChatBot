<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Symfony AI ChatBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <style>
        .typing::after { content: '‚ñã'; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0; } }

        /* Styles pour le Markdown */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            font-weight: bold;
            margin-top: 1rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.3rem; }
        .markdown-content h3 { font-size: 1.1rem; }

        .markdown-content p {
            margin-bottom: 0.75rem;
        }

        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .markdown-content ul { list-style-type: disc; }
        .markdown-content ol { list-style-type: decimal; }

        .markdown-content li {
            margin-bottom: 0.25rem;
        }

        .markdown-content code {
            background-color: rgba(0, 0, 0, 0.3);
            padding: 0.2rem 0.4rem;
            border-radius: 0.25rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background-color: #282c34;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin-bottom: 0.75rem;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #3b82f6;
            padding-left: 1rem;
            margin-left: 0;
            margin-bottom: 0.75rem;
            font-style: italic;
            color: #9ca3af;
        }

        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .markdown-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 0.75rem;
        }

        .markdown-content table th,
        .markdown-content table td {
            border: 1px solid #4b5563;
            padding: 0.5rem;
        }

        .markdown-content table th {
            background-color: rgba(0, 0, 0, 0.3);
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 h-screen flex flex-col font-sans">

    <div class="w-full h-full flex flex-col bg-gray-800 overflow-hidden">
        <div class="p-4 bg-gray-900 border-b border-gray-700 flex justify-between items-center">
            <h1 class="text-xl font-bold text-blue-400">ü§ñ Symfony RAG Bot</h1>
            <span class="text-xs text-gray-500">Powered by Ollama & API Platform</span>
        </div>

        <div id="chat-box" class="flex-1 p-6 overflow-y-auto space-y-4">
            <div class="text-center text-gray-500 text-sm my-4">Posez une question sur la documentation...</div>
        </div>

        <form id="chat-form" class="p-4 bg-gray-900 border-t border-gray-700 flex gap-2">
            <input type="text" id="user-input" 
                class="flex-1 bg-gray-800 text-white border border-gray-600 rounded-lg px-4 py-3 focus:outline-none focus:border-blue-500 transition"
                placeholder="Ex: Comment cr√©er un Custom Provider ?" autocomplete="off">
            <button type="submit" 
                class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-semibold transition flex items-center gap-2">
                Envoyer ‚û§
            </button>
        </form>
    </div>

    <script>
        // Configuration de marked pour supporter les blocs de code avec highlight.js
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    try {
                        return hljs.highlight(code, { language: lang }).value;
                    } catch (err) {}
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        const chatBox = document.getElementById('chat-box');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');

        // Fonction pour appliquer la coloration syntaxique
        function highlightCodeBlocks(element) {
            element.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightElement(block);
            });
        }

        function appendMessage(role, text, isMarkdown = false) {
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const bubble = document.createElement('div');
            bubble.className = `max-w-[80%] rounded-2xl px-4 py-2 ${
                role === 'user' 
                ? 'bg-blue-600 text-white rounded-br-none' 
                : 'bg-gray-700 text-gray-100 rounded-bl-none shadow-md'
            }`;

            if (isMarkdown && role === 'assistant') {
                bubble.className += ' markdown-content';
            }

            bubble.innerHTML = text;

            div.appendChild(bubble);
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight;
            return bubble;
        }

        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const message = userInput.value.trim();
            if (!message) return;

            // 1. Afficher message user
            appendMessage('user', message);
            userInput.value = '';

            // 2. Pr√©parer bulle r√©ponse
            const botBubble = appendMessage('assistant', '<span class="typing"></span>');

            try {
                // 3. Appel API
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ messages: [{ role: 'user', content: message }] })
                });

                if (!response.ok || !response.body) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = "";
                
                // 4. Lecture du Stream
                botBubble.innerHTML = "";
                botBubble.className += ' markdown-content';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    const chunk = decoder.decode(value, { stream: true });
                    fullResponse += chunk;
                    
                    // Conversion Markdown -> HTML avec marked.js
                    try {
                        const formatted = marked.parse(fullResponse);
                        botBubble.innerHTML = formatted;
                        // Appliquer la coloration syntaxique
                        highlightCodeBlocks(botBubble);
                    } catch (err) {
                        // En cas d'erreur de parsing, afficher le texte brut
                        botBubble.innerText = fullResponse;
                    }

                    chatBox.scrollTop = chatBox.scrollHeight;
                }

            } catch (err) {
                botBubble.innerText = "Erreur : " + err.message;
            }
        });
    </script>
</body>
</html>